# Yandex 360 Text Admin Console

## Обзор

Консольная утилита [`360_text_admin_console.py`](360_text_admin_console.py:1) предназначена для администрирования организации Yandex 360 через API. Утилита предоставляет широкий функционал для управления пользователями, группами, настройками электронной почты и двухфакторной аутентификации.

## Основные возможности

### 1. Управление атрибутами пользователей
- Изменение атрибута `userName` через SCIM API
- Изменение атрибута `nickname` через Yandex 360 API
- Массовое обновление пользователей из CSV-файла
- Проверка псевдонимов и алиасов

### 2. Получение информации о пользователях
- Выгрузка всех пользователей в CSV-файлы (SCIM и API 360)
- Детальная информация об атрибутах пользователя
- Проверка существования псевдонимов

### 3. Управление группами
- Просмотр атрибутов групп
- Управление разрешениями на отправку в группы
- Добавление/удаление пользователей в списки разрешенных отправителей
- Работа с общими почтовыми ящиками

### 4. Настройки электронной почты
- Управление настройками отправителя по умолчанию
- Просмотр и очистка правил пересылки
- Массовое обновление настроек из файла

### 5. Двухфакторная аутентификация (2FA)
- Выгрузка настроек 2FA для всех пользователей
- Сброс телефона безопасности
- Принудительный выход пользователей из системы
- Автоматический выход пользователей с включенной 2FA без настроенного телефона

## Установка

1. **Установите Python 3.7 или выше**

2. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Настройте файл окружения:**
   Создайте файл [`.env`](.env:1) в корневой директории проекта со следующими параметрами:

## Параметры конфигурации

| Параметр | Описание | Обязательный | Пример |
|----------|----------|--------------|--------|
| `SCIM_TOKEN_ARG` | OAuth-токен для SCIM API | Да* | `y0_AgAAAAAAAAAAAA` |
| `SCIM_DOMAIN_ID_ARG` | ID домена для SCIM API | Да* | `1234567` |
| `OAUTH_TOKEN_ARG` | OAuth-токен для Yandex 360 API | Да | `y0_AgAAAAB0It5oAAvg` |
| `ORG_ID_ARG` | ID организации Yandex 360 | Да | `1234567` |
| `USERS_FILE_ARG` | Имя CSV-файла с пользователями | Да | `users.csv` |
| `NEW_LOGIN_DEFAULT_FORMAT_ARG` | Шаблон нового userName | Нет | `alias@domain.ru` |
| `DEFAULT_EMAIL_OUTPUT_FILE_ARG` | Файл для экспорта настроек email | Нет | `default_email_output.csv` |
| `DEFAULT_EMAIL_INPUT_FILE_ARG` | Файл для импорта настроек email | Нет | `default_email_input.csv` |
| `DEFAULT_FORWARD_RULES_OUTPUT_FILE_ARG` | Файл для экспорта правил пересылки | Нет | `forward_rules_output.csv` |
| `DEFAULT_2FA_SETTINGS_OUTPUT_FILE_ARG` | Файл для экспорта настроек 2FA | Нет | `users_2fa_output.csv` |
| `DEFAULT_2FA_SETTINGS_INPUT_FILE_ARG` | Файл для импорта настроек 2FA | Нет | `users_2fa_input.csv` |
| `IgnoreUsernameDomain` | Игнорировать домен в userName | Нет | `true/false` |

*\* SCIM параметры необходимы только для операций с userName*

### Пример файла `.env`:
```env
SCIM_TOKEN_ARG=y0_AgAAAAAAAAAAAA
SCIM_DOMAIN_ID_ARG=1234567
OAUTH_TOKEN_ARG=y0_AgAAAAB0It5oAAvg
ORG_ID_ARG=1234567
USERS_FILE_ARG=users.csv
NEW_LOGIN_DEFAULT_FORMAT_ARG=alias@domain.ru
```

## Запуск

### Интерактивный режим
```bash
python 360_text_admin_console.py
```

### Командная строка
```bash
# Изменение userName
python 360_text_admin_console.py old_username new_username userName yes

# Изменение nickname
python 360_text_admin_console.py old_nickname new_nickname nickname yes
```

## Структура меню

### Главное меню
1. **Работа с атрибутами userName и nickname**
2. **Получение информации о пользователях**
3. **Получение информации о группах и управление разрешениями**
4. **Работа с настройками электронной почты**
5. **Настройки 2FA**

### Подменю 1: Атрибуты пользователей
1. Установка формата нового userName
2. Создание файла данных SCIM для модификации
3. Массовое изменение userName из файла
4. Ручное изменение userName
5. Изменение nickname пользователя
6. Проверка псевдонима
7. Сохранение атрибутов пользователя в файл
8. Выгрузка всех пользователей

### Подменю 2: Информация о пользователях
1. Проверка псевдонима
2. Выгрузка всех пользователей
3. Детальная информация об атрибутах пользователя

### Подменю 3: Управление группами
1. Сохранение атрибутов группы в файл
2. Просмотр разрешенных отправителей
3. Управление разрешениями на отправку

### Подменю 4: Настройки электронной почты
1. Создание файла для изменения настроек отправителя
2. Обновление настроек из файла
3. Просмотр правил пересылки для пользователя
4. Выгрузка правил пересылки для всех пользователей
5. Очистка правил пересылки

### Подменю 5: Настройки 2FA
1. Выгрузка настроек 2FA для всех пользователей
2. Просмотр настроек 2FA для пользователя
3. Сброс телефона безопасности
4. Принудительный выход пользователя
5. Принудительный выход пользователей из файла
6. Выход пользователей с 2FA без телефона

## Форматы файлов

### CSV-файл пользователей (users.csv)
```csv
uid;displayName;old_userName;new_userName
1130000069123456;Иванов Иван;ivan@contoso.com;ivan@contoso.ru
1130000069123457;Петров Петр;petr@contoso.com;petr@contoso.ru
```

### CSV-файл настроек email
```csv
nickname;new_DefaultEmail;new_DisplayName;old_DefaultEmail;old_DisplayName;uid
ivan;ivan@newdomain.com;Иван Иванов;ivan@olddomain.com;Ivan;1130000069123456
```

### CSV-файл настроек 2FA
```csv
uid;nickname;displayName;isEnabled;isAdmin;domain2FAEnabled;hasSecurityPhone;personal2FAEnabled;global2FAEnabled;global2FADuration;global2FAPolicy
1130000069123456;ivan;Иванов Иван;true;false;true;false;false;true;86400;all_users
```

## Получение токенов

### SCIM API токен
1. Перейдите на https://oauth.yandex.ru/client/new/
2. Создайте приложение с разрешением `passport:scim-api.all`
3. Получите токен через `client_credentials`

### Yandex 360 API токен
1. Создайте приложение с разрешениями:
   - `directory:read_users`
   - `directory:write_users`
2. Получите токен через authorization code flow

Подробные инструкции по получению токенов см. в [документации Yandex 360](https://yandex.ru/dev/api360/doc/ru/).

## Логирование

- **Консоль**: Сообщения уровня INFO
- **Файл**: [`360_text_admin_console.log`](360_text_admin_console.log:1) с ротацией (10 МБ, 5 копий)
- **Уровень**: DEBUG для файла, INFO для консоли

## Примеры использования

### Массовое изменение userName
```bash
# 1. Создать файл с данными пользователей
python 360_text_admin_console.py
# Выбрать: 1 -> 2

# 2. Отредактировать users.csv
# 3. Применить изменения
python 360_text_admin_console.py
# Выбрать: 1 -> 3
```

### Управление разрешениями группы
```bash
python 360_text_admin_console.py
# Выбрать: 3 -> 3 -> 1 (установить целевую группу)
# Затем: 3 -> 3 -> 2 (добавить пользователей)
```

### Выгрузка настроек 2FA
```bash
python 360_text_admin_console.py
# Выбрать: 5 -> 1
```

## Ограничения и особенности

- Поддерживаются только пользователи с ID, начинающимся с "113"
- SCIM API требует отдельного токена и настройки
- Некоторые операции требуют административных прав
- Массовые операции могут занимать значительное время
- Рекомендуется остановить службу SCIM перед изменением userName

## Обработка ошибок

- Автоматические повторы запросов (до 3 попыток)
- Детальное логирование ошибок
- Валидация входных данных
- Проверка токенов при запуске

## Требования

- Python 3.7+
- Библиотеки из [`requirements.txt`](requirements.txt:1)
- Действующие токены Yandex 360 API
- Права администратора организации

## Поддержка

Для получения поддержки обратитесь к документации Yandex 360 API или создайте issue в репозитории проекта.
